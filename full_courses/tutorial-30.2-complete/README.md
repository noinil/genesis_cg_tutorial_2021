# CG MD simulations for DNA with the 3SPN.2C model

The 3SPN.2C model<sup>[1](#ref-3spn2c)</sup> represent every nucleotide as three
coarse-grained particles, phosphate (P), sugar (S), and base (B).  Here we show
an example of simulating a 50bp double-stranded DNA (dsDNA) with this model in
Genesis<sup>[2](#ref-3spn2c)</sup>.  We will cover the steps from setting up the
system to doing some simple analysis.

## 01 Prepare the system

We get started from preparing the topology and coordinate files for the system.
Unlike atomistic simulations, we cannot simply make use of the PDB file and make
a call to some library of force-field parameter files.  Actually we don't even
have a PDB ready to use.  In the 3SPN.2C model, the reference structure is
generated by the [3DNA](https://x3dna.org/) package<sup>[3](#ref-3dna)</sup>.
We will make topology files based on this reference structure.

We need a small tool to help us.  Let's download it:
```bash
> git clone https://github.com/noinil/genesis_cg_input.git
```

This little tool consists of some Julia scripts that will help us read
coordinates from PDB and write down parameters such as bond lenght, angles,
contact interactions and so on.  Hereafter we call it "CG_TOOL".

---

![CG DNA with 3SPN.2C model.](../share/dna_3spn2c_fig1_CG_system.png)


Now let's go ahead to the first step:
```bash
> cd DNA_3SPN.2C
> cd 01_preparation
> ls
dsDNA.fasta
```

This file contains a randomly generated sequence for our dsDNA.  Use `cat` to
have a look.

We then use the "CG_TOOL", which calls `x3dna`, to build the atomistic structure
and then write some information for the CG model that Genesis can understand:

```bash
> $PATH_TO_CG_TOOL/tools/DNA_3SPN.2C/bdna_3spn2c_gen.sh dsDNA.fasta 
```

Here `$PATH_TO_CG_TOOL` is the directory where you downloaded the "CG_TOOL".
After running the command above, you will get seven new files:
```bash
> ls
dsDNA_x3dna_new_cg.gro
dsDNA_x3dna_new_cg.itp
dsDNA_x3dna_new_cg.pdb
dsDNA_x3dna_new_cg.psf
dsDNA_x3dna_new_cg.top
dsDNA_x3dna_new.pdb
dsDNA_x3dna.pdb
```

There are two atomistic ".pdb" files: 
- `dsDNA_x3dna.pdb`, which is created by `x3dna`,
- `dsDNA_x3dna_new.pdb`, which is further trimed by our "CG_TOOL".

A new ".pdb" file is generated for the CG model, `dsDNA_x3dna_new_cg.pdb`.  This
PDB and a ".psf" file will be reqired in the analysis step.  The ".gro" file has
all the CG coordinates for MD simulation.  The ".itp" file contains the
parameters for all the bonds, angles, and dihedral angles.  Finally, the ".top"
file connects our ".itp" and some library parameter files together.

That's all.  We can move on to the simulations now.



## 02 Run MD simulations

Here we are going to partially melt the dsDNA, and then simulate the refolding
(usually called hybridization).

### 02.1 DNA melting

Now move to the melting simulation working directory:
```bash
> cd 02.1_simulation_melting
> ls
dna.atin
```

This file "dna.atin" contains the information for Genesis to perform the MD
simulation.  Let's take a look:

```bash
> cat dna.atin
```

```
[INPUT]
grotopfile              = dsDNA_x3dna_new_cg.top
grocrdfile              = dsDNA_x3dna_new_cg.gro

[OUTPUT]
pdbfile                 = dna_test_melt.pdb
dcdfile                 = dna_test_melt.dcd
rstfile                 = dna_test_melt.rst

[ENERGY]
forcefield              = AICG2P
electrostatic           = CUTOFF
CG_DNA_BP_cutoffdist    = 18.0
CG_DNA_BP_pairlistdist  = 23.0
CG_DNA_ele_cutoffdist   = 50.0
CG_DNA_ele_pairlistdist = 55.0
CG_sol_ionic_strength   = 0.15

[DYNAMICS]
integrator              = VVER
nsteps                  = 30000
timestep                = 0.010
eneout_period           = 1000
crdout_period           = 1000
rstout_period           = 1000
nbupdate_period         = 10
stoptr_period           = 10
verbose                 = YES

[CONSTRAINTS]
rigid_bond              = NO

[ENSEMBLE]
ensemble                = NVT
tpcontrol               = LANGEVIN
temperature             = 600   # High-temperature for DNA melting!
gamma_t                 = 0.01

[BOUNDARY]
type                    = NOBC
```

Most options here are self-explaining.  For instance, the force field we are
using is the "AICG2P" (we are still using the model name for protein),
melting will be carried out for 30000 steps at 600K...  Please refer
to Genesis manual for more detailed descriptions.

Now let's copy the files we prepared in the first step:
```bash
> ./copy_files.sh
```

**IMPORTANT** This time we have to do some modifications to the ".top" file
created with the "CG_TOOL".

```bash
> cat dsDNA_x3dna_new_cg.top
; atom types for coarse-grained models
#include "./lib/atom_types.itp" 

; Molecule topology 
#include "./top/dsDNA_x3dna_new_cg.itp" 

[ system ] 
dsDNA_x3dna_new 

[ molecules ] 
dsDNA_x3dna_new  1 

; [ cg_ele_mol_pairs ] 
; ON 1 - 2 : 3 - 4 
; OFF 1 - 1 : 3 - 3 

; [ pwmcos_mol_pairs ] 
; ON 1 - 2 : 3 - 4 
; OFF 1 - 1 : 3 - 3
```

Notice that the `[ cg_ele_mol_pairs ]` block is commented out.  We have to
re-enable it so that our DNA phosphates can have electrostatic interactions.
Let's turn on interactions between the DNA strands in this way (please modify
the ".top" file with vim or emacs or any other editor as you like):

```bash
[ cg_ele_mol_pairs ] 
ON 1 - 2 : 1 - 2
```

Now any "P" particle in strand 1 and strand 2 can feel the electrostatic
repulsions from each other (actually except the neighboring ones, according to
the model).

Let's run genesis:
```bash
> $PATH_TO_GENESIS/src/atdyn/atdyn dna.atin > dna_test_melt.log
```

This short simulation takes tens of seconds to finish on my desktop computer.
We get four new files from this simulation:

```bash
dna_test_melt.dcd
dna_test_melt.pdb
dna_test_melt.rst
dna_test_melt.log
```

The ".dcd" file contains trajectory coordinates.  The ".pdb" file is the
conformation of the last frame of this simulation.  And the ".rst" file is
prepared for Genesis to run more simulations from this configuration.

### 02.2 DNA hybridization

We will get started from the melted DNA structure.
```bash
> cd 02.2_simulation_hybridization
> ls
dna.atin
```

See what's different in the control file:

```bash
> cat dna.atin
```

```
[INPUT]
grotopfile              = dsDNA_x3dna_new_cg.top
grocrdfile              = dsDNA_x3dna_new_cg.gro
rstfile                 = dna_test_melt.rst

[OUTPUT]
pdbfile                 = dna_test_hybrid.pdb
dcdfile                 = dna_test_hybrid.dcd
rstfile                 = dna_test_hybrid.rst

[ENERGY]
forcefield              = AICG2P
electrostatic           = CUTOFF
CG_DNA_BP_cutoffdist    = 18.0
CG_DNA_BP_pairlistdist  = 23.0
CG_DNA_ele_cutoffdist   = 50.0
CG_DNA_ele_pairlistdist = 55.0
CG_sol_ionic_strength   = 0.15

[DYNAMICS]
integrator              = VVER
nsteps                  = 200000
timestep                = 0.010
eneout_period           = 1000
crdout_period           = 1000
rstout_period           = 1000
nbupdate_period         = 10
stoptr_period           = 10
verbose                 = YES

[CONSTRAINTS]
rigid_bond              = NO

[ENSEMBLE]
ensemble                = NVT
tpcontrol               = LANGEVIN
temperature             = 300
gamma_t                 = 0.05

[BOUNDARY]
type                    = NOBC
```

Note that according to the `dna.atin` file the initial coordinates will be read
from the "rstfile" in the "[INPUT]" block.

Now let's copy the melted structures as well as the topology files here:
```bash
> ./copy_files.sh
```

Now we can run genesis again:
```bash
> $PATH_TO_GENESIS/src/atdyn/atdyn dna.atin > dna_test_hybrid.log
```

New files will be created:
```
dna_test_hybrid.dcd
dna_test_hybrid.pdb
dna_test_hybrid.rst
dna_test_hybrid.log
```

Check the ".log" file for different energy terms (such as base-pairing and
base-stacking)!



## 03 Analysis with genesis: RMSD

We will try to compute RMSD from the trajectories we get in step 02.1 and 02.2.

```bash
> cd 03_analysis
> ls
rmsd_melt.atin
rmsd_hybrid.atin
```

Take a look at one:
```bash
> cat rmsd_melt.atin
```

```
[INPUT]
psffile        = ../01_preparation/dsDNA_x3dna_new_cg.psf
reffile        = ../01_preparation/dsDNA_x3dna_new_cg.pdb

[OUTPUT]
rmsfile        = run_melt.rms

[TRAJECTORY]
trjfile1       = ../02.1_simulation_melting/dna_test_melt.dcd
md_step1       = 30000
mdout_period1  = 1000
ana_period1    = 1
trj_format     = DCD
trj_type       = COOR

[SELECTION]
group1         = all

[FITTING]
fitting_method = TR+ROT
fitting_atom   = 1

[OPTION]
check_only     = NO
```

You may need to modify something like "md_step1" or "mdout_period1" if you used
options different from my input file as shown in step 02.1.

Note that the `../01_preparation/dsDNA_x3dna_new_cg.pdb` contains the
coordinates of the B-form DNA.  We will use this file as the reference for RMSD
calculation.

```bash
> $PATH_TO_GENESIS/src/analysis/converter/crd_convert/crd_convert rmsd_melt.atin
> $PATH_TO_GENESIS/src/analysis/converter/crd_convert/crd_convert rmsd_hybrid.atin
```

We will get two new files containing all the RMSD data:
```
> ls
run_melt.rms
run_hybrid.rms

> head run_melt.rms
         1    2.867
         2    3.045
         3    2.758
         4    2.770
         5    2.830
         6    2.671
         7    4.019
         8    6.358
         9    7.478
        10    8.370
```

Now you may use some data-visualization tools such as `gnuplot` to plot out the
time series of RMSD.

![Time series of RMSD from DNA melting and hybridization simulation.](../share/dna_3spn2c_fig2_RMSD_ts.png)


---


<a name="ref-3spn2c">1</a>. Freeman, G. S., Hinckley, D. M., Lequieu, J. P., Whitmer, J. K., de Pablo, J. J., **2014**, _J. Chem. Phy._, 141 (16), 165103.

<a name="ref-genesis">2</a>. Kobayashi. C, Jung. J, Matsunaga. Y, Mori. T, Ando. T, Tamura. K, Kamiya. M, and Sugita. Y, **2017**, _J. Compute. Chem._, 38, 2193-2206.

<a name="ref-3dna">3</a>. Lu XJ., Olson W. K., **2003**, _Nucleic Acids Res._, 31(17), 5108-5121.
